docker_stacks:
  portainer:
    mode: swarm
    state: present

    allow_prune: true

    directories:
      data:
        path: /srv/portainer

    services:
      agent:
        image: portainer/agent:lts
        ports:
          - 9001:9001
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - /var/lib/docker/volumes:/var/lib/docker/volumes
          - /:/host
        networks:
          - default
        deploy:
          mode: global
          labels:
            shepherd.autodeploy: "true"

      controller:
        image: portainer/portainer-ce:lts
        command:
          - -H
          - tcp://tasks.agent:9001
          - --tlsskipverify
        ports:
          - 9000:9000
        volumes:
          - "$_data:/data"
        networks:
          - default
          - proxy
        deploy:
          mode: replicated
          replicas: 1
          placement:
            constraints:
              - node.role == manager
          labels:
            traefik.enable: "true"
            traefik.swarm.network: "proxy"
            traefik.http.routers.portainer.rule: "Host(`portainer.example.com`)"
            traefik.http.routers.portainer.middlewares: "internal-only@file"
            traefik.http.services.portainer.loadbalancer.server.port: "9000"
            shepherd.autodeploy: "true"

    networks:
      default:
      proxy:
        external: true
        driver: overlay
        attachable: true
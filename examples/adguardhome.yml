docker_stacks:
  adguardhome:
    mode: swarm
    state: present

    allow_prune: true

    directories:
      data:
        path: /srv/adguard2

    services:
      server:
        image: adguard/adguardhome:latest
        volumes:
          - "$_data/work:/opt/adguardhome/work"
          - "$_data/conf:/opt/adguardhome/conf"
        ports:
          - target: 53
            published: 53
            protocol: tcp
            mode: host
          - target: 53
            published: 53
            protocol: udp
            mode: host
          # - 3000:3000
        networks:
          - proxy
        labels:
          keepalived.vip: "adguard"
        deploy:
          mode: replicated
          replicas: 1
          placement:
            constraints:
              - node.role == manager
          labels:
            traefik.enable: "true"
            traefik.http.routers.adguard.rule: "Host(`adguard.example.com`)"
            traefik.http.services.adguard.loadbalancer.server.port: "80"
            traefik.http.services.adguard.loadbalancer.sticky.cookie: "true"
            shepherd.autodeploy: "true"

    networks:
      proxy:
        external: true
        driver: overlay
        attachable: true
docker_stacks:
  traefik:
    mode: swarm
    state: present

    allow_prune: true

    directories:
      data:
        path: /srv/traefik

    services:
      controller:
        image: traefik:v3.6
        command:
          # --- API ---
          - "--api.dashboard=true"
          - "--api.insecure=false"

          # --- Backend TLS Verify ---
          - "--serversTransport.insecureSkipVerify=true"

          # --- Providers ---
          - "--providers.swarm=true"
          - "--providers.swarm.exposedByDefault=false"
          - "--providers.swarm.network=proxy"
          - "--providers.file.watch=true"
          - "--providers.file.directory=/etc/traefik/config"

          # --- EntryPoints ---
          # web (80)
          - "--entrypoints.web.address=:80"
          - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
          - "--entrypoints.web.http.redirections.entrypoint.scheme=https"

          - "--entrypoints.web.transport.respondingtimeouts.idletimeout=120s"
          - "--entrypoints.web.transport.respondingtimeouts.readtimeout=60s"
          - "--entrypoints.web.transport.respondingtimeouts.writetimeout=60s"

          # websecure (443)
          - "--entrypoints.websecure.address=:443"
          - "--entrypoints.websecure.asdefault=true"

          - "--entrypoints.websecure.http.tls.certresolver=letsencrypt"
          - "--entrypoints.websecure.http.tls.domains[0].main=example.com"
          - "--entrypoints.websecure.http.tls.domains[0].sans=*.example.com,*.lab.example.com"

          - "--entrypoints.websecure.transport.respondingtimeouts.idletimeout=120s"
          - "--entrypoints.websecure.transport.respondingtimeouts.readtimeout=60s"
          - "--entrypoints.websecure.transport.respondingtimeouts.writetimeout=60s"

          # mqttsecure (8883)
          - "--entrypoints.mqttsecure.address=:8883"

          # --- Certificates (ACME / Let's Encrypt) ---
          - "--certificatesresolvers.letsencrypt.acme.email=admin@example.com"
          - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
          - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-v02.api.letsencrypt.org/directory"

          - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
          - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
          - "--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53"
          - "--certificatesresolvers.letsencrypt.acme.dnschallenge.propagation.delayBeforeChecks=5s"

          # --- Logging ---
          - "--log.level=INFO"
          - "--log.format=common"

          # --- Access Logs ---
          - "--accesslog=false"
          - "--accesslog.format=json"
          - "--accesslog.filters.statuscodes=400-499,500-599"

          # --- Misc ---
          - "--global.checknewversion=false"
          - "--global.sendanonymoususage=false"

        ports:
          - target: 80
            published: 80
            protocol: tcp
            mode: host
          - target: 443
            published: 443
            protocol: tcp
            mode: host
          - target: 8883
            published: 8883
            protocol: tcp
            mode: host
        environment:
          TZ: "America/Chicago"
          CF_DNS_API_TOKEN_FILE: "/run/secrets/cf_dns_api_token"
        labels:
          keepalived.vip: traefik
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock:ro
          - "$_config:/etc/traefik/config:ro"
          - "$_data:/letsencrypt"
        networks:
          - proxy
        secrets:
          - source: cf_dns_api_token
            target: cf_dns_api_token
        deploy:
          replicas: 1
          placement:
            constraints: [node.role == manager]
          restart_policy:
            condition: any
            delay: 5s
          update_config:
            parallelism: 1
            delay: 10s
            order: start-first
            failure_action: rollback
          labels:
            shepherd.autodeploy: "true"

    networks:
      proxy:
        external: true
        driver: overlay
        attachable: true

    secrets:
      cf_dns_api_token:
        value: "{{ acme_dns_cloudflare_api_token | default('') }}"

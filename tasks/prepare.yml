# -------------------------------------------------------------------
# Purpose:
#   Normalize and finalize the docker_stack data structure before rendering
#   templates or creating directories.
# -------------------------------------------------------------------

- name: Ensure docker_stack.state is defined
  ansible.builtin.set_fact:
    docker_stack: >-
      {{
        docker_stack
        | combine(
            {'state': docker_stack.state | default('present')},
            recursive=True
          )
      }}

- name: Compute base and stack paths
  ansible.builtin.set_fact:
    _base_path: "{{ docker_stack.directories.base.path | default('/opt/stacks') }}"

- name: Compute stack path
  ansible.builtin.set_fact:
    _stack_path: "{{ docker_stack.directories.stack.path | default(_base_path ~ '/' ~ docker_stack.name) }}"

- name: Compute core directories
  ansible.builtin.set_fact:
    _core_dirs:
      base:
        path: "{{ _base_path }}"
        owner: "{{ docker_stack.directories.base.owner | default(docker_stack.directories_defaults.owner) | default('root') }}"
        group: "{{ docker_stack.directories.base.group | default(docker_stack.directories_defaults.group) | default('docker') }}"
        mode: "{{ docker_stack.directories.base.mode | default(docker_stack.directories_defaults.mode) | default('0755') }}"
      stack:
        path: "{{ _stack_path }}"
        owner: "{{ docker_stack.directories.stack.owner | default(docker_stack.directories_defaults.owner) | default('root') }}"
        group: "{{ docker_stack.directories.stack.group | default(docker_stack.directories_defaults.group) | default('docker') }}"
        mode: "{{ docker_stack.directories.stack.mode | default(docker_stack.directories_defaults.mode) | default('0755') }}"
      config:
        path: "{{ docker_stack.directories.config.path | default(_stack_path ~ '/config') }}"
        owner: "{{ docker_stack.directories.config.owner | default(docker_stack.directories_defaults.owner) | default('root') }}"
        group: "{{ docker_stack.directories.config.group | default(docker_stack.directories_defaults.group) | default('docker') }}"
        mode: "{{ docker_stack.directories.config.mode | default(docker_stack.directories_defaults.mode) | default('0755') }}"
      data:
        path: "{{ docker_stack.directories.data.path | default(_stack_path ~ '/data') }}"
        owner: "{{ docker_stack.directories.data.owner | default(docker_stack.directories_defaults.owner) | default('root') }}"
        group: "{{ docker_stack.directories.data.group | default(docker_stack.directories_defaults.group) | default('docker') }}"
        mode: "{{ docker_stack.directories.data.mode | default(docker_stack.directories_defaults.mode) | default('0755') }}"
      secrets:
        path: "{{ docker_stack.directories.secrets.path | default(_stack_path ~ '/secrets') }}"
        owner: "{{ docker_stack.directories.secrets.owner | default(docker_stack.directories_defaults.owner) | default('root') }}"
        group: "{{ docker_stack.directories.secrets.group | default(docker_stack.directories_defaults.group) | default('root') }}"
        mode: "{{ docker_stack.directories.secrets.mode | default(docker_stack.directories_defaults.mode) | default('0700') }}"

- name: Compute extra directories
  ansible.builtin.set_fact:
    _extra_dirs: >-
      {%- set d = {} -%}
      {%- for key, val in docker_stack.directories.items() -%}
        {%- if key not in ['base','stack','config','data','secrets'] -%}
          {%- set _ = d.update({
                key: {
                  'path': (val if val is string else val.path) | default(_stack_path ~ '/' ~ key),
                  'owner': (val.owner if val is mapping else None) | default(docker_stack.directories_defaults.owner) | default('root'),
                  'group': (val.group if val is mapping else None) | default(docker_stack.directories_defaults.group) | default('docker'),
                  'mode': (val.mode if val is mapping else None) | default(docker_stack.directories_defaults.mode) | default('0755')
                }
              }) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ d }}

# -------------------------------------------------
# Debug extra directories
# -------------------------------------------------
# - name: Debug extra directories before merging
#   ansible.builtin.debug:
#     msg:
#       extra_dirs: "{{ _extra_dirs }}"

- name: Merge core and extra directories into docker_stack
  ansible.builtin.set_fact:
    docker_stack:
      "{{ docker_stack | combine({'directories': _core_dirs | combine(_extra_dirs, recursive=True)}, recursive=True) }}"

- name: Initialize normalized services
  ansible.builtin.set_fact:
    _normalized_services: {}

- name: Normalize service ports
  ansible.builtin.set_fact:
    _normalized_services: >-
      {%- set result = _normalized_services.copy() -%}
      {%- for svc_name, svc in _normalized_services.copy().items() or docker_stack.services.items() -%}
        {%- set svc_ports = svc.ports | default([]) -%}
        {%- set ports_list = [] -%}
        {%- for p in svc_ports -%}
          {%- if p is string -%}
            {%- set parts = p.split('/') -%}
            {%- set proto = parts[1] if parts | length > 1 else 'tcp' -%}
            {%- set pub_target = parts[0].split(':') -%}
            {%- set published = pub_target[0] | int -%}
            {%- set target = (pub_target[1] | default(pub_target[0])) | int -%}
            {%- set _ = ports_list.append({'published': published, 'target': target, 'protocol': proto}) -%}
          {%- elif p is mapping -%}
            {%- set published = p.published | int -%}
            {%- set target = p.target | int -%}
            {%- set proto = p.protocol | default('tcp') -%}
            {%- if 'mode' in p and p.mode is not none -%}
              {%- set _ = ports_list.append({'published': published, 'target': target, 'protocol': proto, 'mode': p.mode}) -%}
            {%- else -%}
              {%- set _ = ports_list.append({'published': published, 'target': target, 'protocol': proto}) -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set _ = result.update({svc_name: svc | combine({'ports': ports_list}, recursive=True)}) -%}
      {%- endfor -%}
      {{ result }}

- name: Normalize service volumes
  ansible.builtin.set_fact:
    _normalized_services: >-
      {%- set result = _normalized_services.copy() -%}
      {%- for svc_name, svc in _normalized_services.copy().items() -%}
        {%- set vols = [] -%}
        {%- for v in svc.volumes | default([]) -%}
          {# --- Handle $_<dir>[/subpath]:<container_path> --- #}
          {%- if v is string and v.startswith('$_') -%}
            {# Split source vs target only once #}
            {%- set parts = v.split(':', 1) -%}
            {%- set raw_src = parts[0][2:] -%}
            {%- set target = parts[1] -%}
            {# Extract directory key and optional subpath #}
            {%- set src_parts = raw_src.split('/', 1) -%}
            {%- set dir_key = src_parts[0] -%}
            {%- set subpath = src_parts[1] if src_parts | length > 1 else '' -%}
            {# Resolve base directory (hard fail if missing) #}
            {%- set base = docker_stack.directories[dir_key].path
                  | mandatory('Missing docker_stack.directories.' ~ dir_key) -%}
            {# Build final source path #}
            {%- set src = base ~ ('/' ~ subpath if subpath else '') -%}
            {%- set _ = vols.append(src ~ ':' ~ target) -%}
          {%- else -%}
            {%- set _ = vols.append(v) -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set _ = result.update({
              svc_name: svc | combine({'volumes': vols}, recursive=True)
            }) -%}
      {%- endfor -%}
      {{ result }}

- name: Normalize service deploy
  ansible.builtin.set_fact:
    _normalized_services: >-
      {%- set result = _normalized_services.copy() -%}
      {%- for svc_name, svc in _normalized_services.copy().items() -%}
        {%- if svc.deploy is defined -%}
          {%- set deploy = svc.deploy.copy() -%}
          {%- if 'placement' in deploy -%}
            {%- set placement = deploy.placement.copy() -%}
            {%- for key in ['constraints', 'preferences'] -%}
              {%- if key in placement and placement[key] is not iterable -%}
                {%- set placement = placement | combine({key: [placement[key]]}, recursive=True) -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set deploy = deploy | combine({'placement': placement}, recursive=True) -%}
          {%- endif -%}
          {%- set _ = result.update({svc_name: svc | combine({'deploy': deploy}, recursive=True)}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ result }}

- name: Normalize service secrets
  ansible.builtin.set_fact:
    _normalized_services: >-
      {%- set result = _normalized_services.copy() -%}
      {%- for svc_name, svc in _normalized_services.items() -%}
        {%- if svc.secrets is defined and svc.secrets | length > 0 -%}
          {%- set svc_secrets = [] -%}
          {%- for s in svc.secrets -%}
            {# ---- Validation ---- #}
            {%- if s.source is not defined -%}
              {{ fail("Service '" ~ svc_name ~ "' secret entry missing 'source'") }}
            {%- endif -%}
            {%- if docker_stack.secrets[s.source] is not defined -%}
              {{ fail("Service '" ~ svc_name ~ "' references undefined secret '" ~ s.source ~ "'") }}
            {%- endif -%}
            {%- if docker_stack.secrets[s.source].value | default('') == '' -%}
              {{ fail("Secret '" ~ s.source ~ "' has empty value") }}
            {%- endif -%}
            {# ---- Normalize ---- #}
            {%- set secret_entry = {
              'source': s.source,
              'target': s.target | default(s.source)
            } -%}
            {%- if s.uid is defined -%}
              {%- set _ = secret_entry.update({'uid': s.uid | int}) -%}
            {%- endif -%}
            {%- if s.gid is defined -%}
              {%- set _ = secret_entry.update({'gid': s.gid | int}) -%}
            {%- endif -%}
            {%- if s.mode is defined -%}
              {%- set _ = secret_entry.update({'mode': s.mode}) -%}
            {%- endif -%}
            {%- set _ = svc_secrets.append(secret_entry) -%}
          {%- endfor -%}
          {%- set _ = result.update({
            svc_name: svc | combine({'secrets': svc_secrets}, recursive=True)
          }) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ result }}

# -----------------------------
# Debug normalized services and exit play
# -----------------------------
# - name: Debug normalized services and exit
#   block:
#     - name: Show final normalized services
#       ansible.builtin.debug:
#         msg: >
#           Service '{{ item.key }}': {{ item.value }}
#       loop: "{{ _normalized_services | dict2items }}"
#       loop_control:
#         label: "{{ item.key }}"
#       run_once: true

#     - name: Exit play after inspecting normalized services
#       ansible.builtin.fail:
#         msg: "Exiting after debugging _normalized_services."

- name: Merge normalized services into docker_stack
  ansible.builtin.set_fact:
    docker_stack: >-
      {{
        docker_stack
        | combine({'services': _normalized_services}, recursive=True)
      }}

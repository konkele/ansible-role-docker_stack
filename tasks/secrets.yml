# -------------------------------------------------------------------
# Purpose:
#   Normalize, hash, and materialize secrets for docker_stack.
#   Handles both Compose and Swarm modes.
# -------------------------------------------------------------------

- name: "{{ _stack_prefix }} Compute secret hashes"
  ansible.builtin.set_fact:
    docker_stack_secret_hashes: >-
      {{
        dict(
          docker_stack.secrets | dict2items | map(attribute='key') |
          zip(
            docker_stack.secrets | dict2items | map(attribute='value') | map(attribute='value') | map('hash', 'sha256')
          )
        )
      }}
  run_once: true
  no_log: true

- name: "{{ _stack_prefix }} Compute combined secret hash for services"
  ansible.builtin.set_fact:
    docker_stack_combined_secret_hash: >-
      {{
        _normalized_services
        | dict2items
        | map(attribute='value.secrets')
        | select('defined')
        | flatten
        | map(attribute='source')
        | unique
        | map('extract', docker_stack_secret_hashes)
        | join('')
        | hash('sha256')
      }}
  run_once: true
  no_log: true

- name: "{{ _stack_prefix }} Write secret files (compose)"
  ansible.builtin.copy:
    content: "{{ item.value.value }}"
    dest: "{{ docker_stack.directories.secrets.path }}/{{ item.key }}"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ docker_stack.secrets | dict2items }}"
  when:
    - docker_stack.mode == "compose"
  no_log: true

- name: "{{ _stack_prefix }} Create hashed swarm secrets (labeled)"
  community.docker.docker_secret:
    name: >-
      {{
        (item.key | regex_replace('^_+', '') | regex_replace('_+$', ''))[:55]
        ~ '_'
        ~ docker_stack_secret_hashes[item.key][:8]
      }}
    data: "{{ item.value.value }}"
    labels:
      managed-by: ansible
      stack: "{{ docker_stack.name }}"
      secret: "{{ item.key }}"
      secret_hash: "{{ docker_stack_secret_hashes[item.key] }}"
    state: present
  loop: "{{ docker_stack.secrets | dict2items }}"
  when: 
    - docker_stack.mode == "swarm"
  run_once: true
  no_log: true

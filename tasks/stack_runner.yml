# -------------------------------------------------------------------
# Stack Runner
#
# Purpose:
#   Orchestrate the lifecycle of a single docker_stack based on its
#   desired state ('present', 'absent', or 'restart').
#
# Responsibilities:
#   - Initialize the stack variable for this iteration
#   - Merge layered variables
#   - Validate input structure
#   - Prepare normalized paths, services, directories, ports, volumes, deploy, and secrets
#   - Remove the stack if state=absent
#   - Deploy the stack if state=present
#   - Restart the stack if state=restart
# -------------------------------------------------------------------

# Initialize stack variables
- name: Initialize docker_stack for this iteration
  ansible.builtin.set_fact:
    docker_stack:
      "{{ stack_item.value | combine({'name': stack_item.key}) }}"

# Initialize task name prefix
- name: Define stack task prefix
  ansible.builtin.set_fact:
    _stack_prefix: "[{{ docker_stack.name }}]"

# Merge docker_stack variables from defaults, group, host, and overrides
- name: "{{ _stack_prefix }} Merge docker stack variables"
  import_tasks: merge.yml
  vars:
    merge_var_specs:
      - name: docker_stack

# Validate the docker_stack input structure and required fields
- name: "{{ _stack_prefix }} Validate docker_stack input"
  import_tasks: validate.yml

# Prepare and normalize all paths, directories, services, ports, volumes, deploy blocks, and secrets
- name: "{{ _stack_prefix }} Prepare variables"
  import_tasks: prepare.yml

# Remove the stack if it is marked as absent
- name: "{{ _stack_prefix }} Remove stack"
  import_tasks: remove_stack.yml
  when: docker_stack.state == 'absent'

# Deploy the stack if it is marked as present
- name: "{{ _stack_prefix }} Deploy stack"
  block:
    # Ensure all stack directories exist with correct permissions
    - name: "{{ _stack_prefix }} Ensure stack directories"
      import_tasks: directories.yml

    # Ensure external networks required by the stack exist
    - name: "{{ _stack_prefix }} Ensure networks"
      import_tasks: networks.yml

    # Manage secrets (create or update) for Compose and Swarm
    - name: "{{ _stack_prefix }} Manage secrets"
      import_tasks: secrets.yml
      when:
        - docker_stack.secrets is defined
        - docker_stack.secrets | length > 0

    # Build normalized compose dictionary
    - name: "{{ _stack_prefix }} Build compose dictionary"
      import_tasks: build_compose_dict.yml

    # Render the docker-compose.yml from the Jinja2 template
    - name: "{{ _stack_prefix }} Render stack template"
      import_tasks: render.yml

    # Deploy the stack using Docker Compose or Docker Swarm
    - name: "{{ _stack_prefix }} Deploy docker stack"
      import_tasks: deploy.yml

    # Wait for Swarm services to be active before continuing
    - name: "{{ _stack_prefix }} Wait for Swarm services"
      ansible.builtin.command: >
        docker stack services {{ docker_stack.name }}
      register: stack_services
      retries: 10
      delay: 3
      until: stack_services.rc == 0
      changed_when: false
      when:
        - docker_stack.mode == 'swarm'
      run_once: true
  when: docker_stack.state == 'present'

# Clean up orphaned secrets for the stack (Swarm only)
- name: "{{ _stack_prefix }} Prune orphaned secrets"
  import_tasks: prune_secrets.yml
  when:
    - docker_stack.secrets is defined
    - docker_stack.secrets | length > 0
    - docker_stack.state == 'present'
  run_once: true

# Restart the stack by stopping and starting services
- name: "{{ _stack_prefix }} Restart stack"
  block:
    # Restart services in Swarm mode
    - name: "{{ _stack_prefix }} Restart Swarm services"
      ansible.builtin.command: docker stack deploy -c {{ docker_stack.directories.stack.path }}/docker-compose.yml {{ docker_stack.name }}
      when:
        - docker_stack.mode == 'swarm'
        - docker_stack.state == 'restart'
      run_once: true
      changed_when: true

    # Restart services in Compose mode
    - name: "{{ _stack_prefix }} Restart Compose services"
      community.docker.docker_compose_v2:
        project_src: "{{ docker_stack.directories.stack.path }}"
        state: restarted
      when:
        - docker_stack.mode == 'compose'
        - docker_stack.state == 'restart'
      changed_when: true

  when: docker_stack.state == 'restart'

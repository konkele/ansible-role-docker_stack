# -------------------------------------------------------------------
# Purpose:
#   Remove orphaned secrets for the docker_stack, in both Swarm and Compose modes.
# -------------------------------------------------------------------

# -------------------------------------------------------------------
# Prune Swarm secrets (run once)
# -------------------------------------------------------------------
- name: Prune Swarm secrets
  block:
    - name: List secrets for this stack (by label)
      ansible.builtin.command:
        cmd: >
          docker secret ls
          --filter label=managed-by=ansible
          --filter label=stack={{ docker_stack.name }}
          --format '{{ "{{" }}.Name{{ "}}" }}'
      register: stack_swarm_secrets
      changed_when: false

    - name: Build authoritative list of swarm secret names
      ansible.builtin.set_fact:
        docker_stack_final_secrets: >-
          {%- set list = [] -%}
          {%- for key in (docker_stack.secrets | default({})).keys() -%}
            {%- set _ = list.append(key + '_' + ((docker_stack_secret_hashes[key] | default(''))[:8])) -%}
          {%- endfor -%}
          {{ list }}

    - name: Identify orphaned swarm secrets
      ansible.builtin.set_fact:
        orphaned_swarm_secrets: >-
          {{
            stack_swarm_secrets.stdout_lines
            | difference(docker_stack_final_secrets)
            | list
          }}

    - name: Remove orphaned swarm secrets
      community.docker.docker_secret:
        name: "{{ item }}"
        state: absent
      loop: "{{ orphaned_swarm_secrets }}"
      failed_when: false
      when: orphaned_swarm_secrets | length > 0

  when: docker_stack.mode == "swarm"
  run_once: true

# -------------------------------------------------------------------
# Prune Compose secrets (per host)
# -------------------------------------------------------------------
- name: Prune Compose secrets
  block:
    - name: List secret files in Compose secrets directory
      ansible.builtin.find:
        paths: "{{ docker_stack.directories.secrets.path }}"
        file_type: file
      register: compose_secret_files

    - name: Identify orphaned Compose secret files
      ansible.builtin.set_fact:
        orphaned_compose_secrets: >-
          {{
            compose_secret_files.files
            | map(attribute='path')
            | map('basename')
            | difference((docker_stack.secrets.keys() | list) | default([]))
            | list
          }}

    - name: Remove orphaned Compose secret files
      ansible.builtin.file:
        path: "{{ docker_stack.directories.secrets.path }}/{{ item }}"
        state: absent
      loop: "{{ orphaned_compose_secrets }}"
      when: orphaned_compose_secrets | length > 0

  when: docker_stack.mode == "compose"

# -------------------------------------------------------------------
# Main entrypoint for docker_stack role
#
# Purpose:
#   1. Normalize input docker_stacks into a consistent list format
#   2. Apply defaults to each stack
#   3. Process each stack individually through stack_runner.yml
# -------------------------------------------------------------------

- name: Ensure docker_stacks is defined
  ansible.builtin.set_fact:
    docker_stacks: "{{ docker_stacks | default({}) }}"

- name: Apply docker_stacks defaults when empty
  ansible.builtin.set_fact:
    docker_stacks: "{{ docker_stacks_defaults | default({}) }}"
  when: docker_stacks | length == 0

- name: Merge docker_stacks variables
  import_tasks: merge.yml
  vars:
    merge_var_specs:
      - name: docker_stacks

- name: Process each docker stack
  ansible.builtin.include_tasks: stack_runner.yml
  loop: "{{ docker_stacks | dict2items }}"
  loop_control:
    label: "{{ stack_item.key }}"
    loop_var: stack_item

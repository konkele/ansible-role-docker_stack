# -------------------------------------------------------------------
# Purpose:
#   Orchestrate the full lifecycle of a docker_stack based on its desired state.
#
#   Responsibilities:
#     1. Load optional vars file
#     2. Merge layered variables
#     3. Validate input
#     4. Prepare and normalize data
#     5. Remove stack if absent
#     6. Deploy stack if present
# -------------------------------------------------------------------

- name: Load docker stack variables
  include_vars:
    file: "{{ docker_stack_vars_file }}"
  when: docker_stack_vars_file is defined

- name: Merge docker stack variables
  import_tasks: merge.yml
  vars:
    merge_var_specs:
      - name: docker_stack

- name: Validate docker_stack input
  import_tasks: validate.yml

- name: Prepare Variables
  import_tasks: prepare.yml

# ----------------------
# ABSENT STATE
# ----------------------

- name: Remove stack
  import_tasks: remove_stack.yml
  when: docker_stack.state == 'absent'

# ----------------------
# PRESENT STATE
# ----------------------
- name: Ensure stack directories
  import_tasks: directories.yml
  when: docker_stack.state == 'present'

- name: Ensure networks
  import_tasks: networks.yml
  when: docker_stack.state == 'present'

- name: Manage secrets
  import_tasks: secrets.yml
  when:
    - docker_stack.secrets is defined
    - docker_stack.secrets | length > 0
    - docker_stack.state == 'present'

- name: Render stack template
  import_tasks: render.yml
  when: docker_stack.state == 'present'

- name: Deploy docker stack
  import_tasks: deploy.yml
  when: docker_stack.state == 'present'

- name: Wait for Swarm services
  ansible.builtin.command: >
    docker stack services {{ docker_stack.name }}
  register: stack_services
  retries: 10
  delay: 3
  until: stack_services.rc == 0
  changed_when: false
  when:
    - docker_stack.mode == 'swarm'
    - docker_stack.state == 'present'
  run_once: true

- name: Prune orphaned secrets
  import_tasks: prune_secrets.yml
  when:
    - docker_stack.secrets is defined
    - docker_stack.secrets | length > 0
    - docker_stack.state == 'present'
  run_once: true

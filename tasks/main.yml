# -------------------------------------------------------------------
# Main entrypoint for docker_stack role
#
# Purpose:
#   1. Normalize input docker_stacks into a consistent list format
#   2. Apply defaults to each stack
#   3. Process each stack individually through stack_runner.yml
# -------------------------------------------------------------------

# -------------------------------------------------
# Normalize docker_stacks input
# -------------------------------------------------
- name: Normalize docker_stacks
  ansible.builtin.set_fact:
    docker_stacks_list: >-
      {{
        docker_stacks is mapping
        | ternary(
            docker_stacks | dict2items
            | map('combine', attribute='value')
            | map('combine', attribute={'name': item.key})
            | list,
            docker_stacks
          )
      }}

# -------------------------------------------------
# Apply docker_stack_defaults to each stack
# -------------------------------------------------
- name: Prepare docker stacks with defaults
  ansible.builtin.set_fact:
    docker_stacks_prepared: "{{ docker_stacks_prepared | default([]) + [ merged_stack ] }}"
  vars:
    merged_stack: >-
      {{
        docker_stack_defaults
        | combine(item, recursive=True)
      }}
  loop: "{{ docker_stacks_list }}"

# -------------------------------------------------
# Step 4: Process each docker stack individually
# -------------------------------------------------
- name: Process each docker stack
  ansible.builtin.include_tasks: stack_runner.yml
  loop: "{{ docker_stacks_prepared }}"
  loop_control:
    loop_var: stack_input
